@page "/twofactor"
@inject HttpClient Http
@inject NavigationManager NavManager
@inject IJSRuntime JS

<PageTitle>Zwei-Faktor-Auth</PageTitle>

<div class="container py-5">
	<div class="row justify-content-center">
		<div class="col-md-6 col-lg-4">
			<div class="card shadow border-0 rounded-3 mt-4">
				<div class="card-body p-4 text-center">
					<div class="mb-3 text-primary">
						<i class="bi bi-shield-lock-fill" style="font-size: 3rem;"></i>
					</div>
					<h4 class="fw-bold mb-2">Zwei-Faktor-Authentifizierung</h4>
					<p class="text-muted small mb-4">
						Wir haben einen 6-stelligen Code an Ihre hinterlegte E-Mail gesendet.
					</p>

					<form @onsubmit="VerifyCode" @onsubmit:preventDefault>
						<div class="mb-4">
							<label class="form-label visually-hidden">Sicherheitscode</label>
							<input @bind="Code" type="text" class="form-control form-control-lg code-input"
								   placeholder="000000" maxlength="6" required />
						</div>

						<div class="d-grid mb-3">
							<button type="submit" class="btn btn-primary btn-lg" disabled="@isLoading">
								@if (isLoading)
								{
									<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true">Prüfen...</span>
									
								}
								else
								{
									<span>Bestätigen</span>
								}
							</button>
						</div>

						<div class="text-center">
							<a href="#" class="text-decoration-none small text-muted" @onclick="ResendCode">Code nicht erhalten? Erneut senden</a>
						</div>

						<div class="mt-3">
							<a href="/" class="text-decoration-none small text-danger"><i class="bi bi-arrow-left"></i> Zurück zum Login</a>
						</div>

						@if (!string.IsNullOrEmpty(ErrorMessage))
						{
							<div class="alert alert-danger mt-2 text-center">@ErrorMessage</div>
						}
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	private bool isLoading = false;
	private string Code { get; set; } = string.Empty;
	private string ErrorMessage { get; set; } = string.Empty;
	private int UserId { get; set; } // UserId als int

	protected override async Task OnInitializedAsync()
	{
		var requires2FA = await JS.InvokeAsync<string>("sessionStorage.getItem", "requires2FA");
		var userIdString = await JS.InvokeAsync<string>("sessionStorage.getItem", "userId");

		if (string.IsNullOrEmpty(requires2FA) || string.IsNullOrEmpty(userIdString))
		{
			NavManager.NavigateTo("/");
			return;
		}
		var token = await JS.InvokeAsync<string>("localStorage.getItem", "jwt");



		if (!int.TryParse(userIdString, out int userId))
		{
			NavManager.NavigateTo("/");
			return;
		}

		UserId = userId;
	}

	private async Task VerifyCode()
	{
		isLoading = true;
		ErrorMessage = string.Empty;

		try
		{
			var request = new Shared.DTOs.Verify2FARequest
			{
				UserId = UserId,
				Code = Code
			};

			var response = await Http.PostAsJsonAsync("api/auth/verify-2fa", request);

			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<Verify2FAResponse>();

				await JS.InvokeVoidAsync("localStorage.setItem", "jwt", result.Token);

				await JS.InvokeVoidAsync("sessionStorage.removeItem", "requires2FA");
				await JS.InvokeVoidAsync("sessionStorage.removeItem", "userId");
				await JS.InvokeVoidAsync("sessionStorage.setItem", "userRole", result.Role);

				if (result.Role == "prorektor" || result.Role == "teacher")
				NavManager.NavigateTo("/overview");
			}
			else
			{
				ErrorMessage = await response.Content.ReadAsStringAsync();
			}
		}
		catch (Exception ex)
		{
			ErrorMessage = ex.Message;
		}
		finally
		{
			isLoading = false;
		}
	}

	private Task ResendCode()
	{
		
		return Task.CompletedTask;
	}

	public class Verify2FAResponse
	{
		public string Token { get; set; } = string.Empty;
		public string Role { get; set; } = "teacher";
	}
}
